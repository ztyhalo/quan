/*
*********************************************************************************************
*                                   Ìì½ò»ªÄşµç×ÓÓĞÏŞ¹«Ë¾
*                                        Ç¶ÈëÊ½¿ª·¢×é
*
*                                
*
* ÎÄ¼şÃû : Playlogic.c
* Ãè  Êö :ÓïÒô¿ØÖÆ²¥·ÅÂß¼­ÈÎÎñ
* ×÷  Õß : 
* °æ  ±¾ : V1.0
* ÈÕ  ÆÚ :
*********************************************************************************************
*/
//#include "ucos_ii.h"
//#include "stm32f10x.h"
//#include "target.h"
#include "include.h"

#define IDEL                    0
#define FINITE_ONLY             1
#define INFINITE_ONLY           2
#define FINITE_INFINITE_BOTH    3

#define IDEL_PLAY               0
#define FINITE_PLAY             1
#define INFINITE_PLAY           2


/*******************************************************************************
* º¯ÊıÃû³Æ£ºDealPlayInstrction 
* ¹¦ÄÜÃèÊö£º´¦Àí²¥·ÅÖ¸Áî
* Èë¿Ú²ÎÊı£ºÎŞ
* ³ö¿Ú²ÎÊı£ºÎŞ
* Ê¹ÓÃËµÃ÷£ºÎŞ
********************************************************************************/
void DealPlayInstrction(u16 *msg)
{ 
#if OS_CRITICAL_METHOD == 3                      
    OS_CPU_SR  cpu_sr;
#endif
	static u8 instruct = 0;
	static u8 segid = 0;
    instruct = (u8)((*msg & 0x0300) >> 8);
    segid = (u8)(*msg & 0x00FF);
    
	switch(instruct)
	{
        case STOP_ALLFINITE://Í£Ö¹ËùÓĞ²»Ò»Ö±²¥µÄ
            if((VM8978Status.mode == 0)&&(VM8978Status.complete == 0))
            {
                wav_play_stop();//Í£Ö¹·ÅÒô
                Init_PlayStatus();
			}

            FiniteListBuf.segaddr = 0;//Çå¿ÕÓĞÏŞ´Î²¥·ÅÁĞ±í
            FiniteListBuf.playtype = 0;
            FiniteListBuf.playtimes = 0;
            FiniteListBuf.playprior = 0;
            FiniteListBuf.playinterval = 0;

            FiniteListNodeNum = 0;

        break;

        case STOP_SPCINFINITE://Í£Ö¹Ö¸¶¨Ò»Ö±²¥µÄ
            if((VM8978Status.mode != 0)&&(VM8978Status.complete == 0))
            {
                if(VM8978Status.segaddr==segid )
                {
                    wav_play_stop();//Í£Ö¹·ÅÒô
					OS_ENTER_CRITICAL();
                    DelNode(segid);
					OS_EXIT_CRITICAL();
                    Init_PlayStatus();
                    OSTimeDly(20);	
                }  
                else
                {
                    OS_ENTER_CRITICAL();
					DelNode(segid);
					OS_EXIT_CRITICAL();
                }
            }
			else
            {
                OS_ENTER_CRITICAL();
				DelNode(segid);
				OS_EXIT_CRITICAL();
            }
        break;
        case STOP_ALLINFINITE://Í£Ö¹ËùÓĞÒ»Ö±²¥µÄ
            if((VM8978Status.mode != 0)&&(VM8978Status.complete == 0))
            {
                wav_play_stop();//Í£Ö¹·ÅÒô
                Init_PlayStatus();
				OS_ENTER_CRITICAL();
				Del_AllNode();
				OS_EXIT_CRITICAL();							
            }
            
            Init_FreeList();
            
        break;
				
		default:
			break;
	}
}
/*******************************************************************************
* º¯ÊıÃû³Æ£ºDealPlayInstrction 
* ¹¦ÄÜÃèÊö£º´¦Àí²¥·ÅÖ¸Áî
* Èë¿Ú²ÎÊı£ºÎŞ
* ³ö¿Ú²ÎÊı£ºÎŞ
* Ê¹ÓÃËµÃ÷£ºÎŞ
********************************************************************************/
// void DealPlayInstrction1(u8 temp)
// { 
// #if OS_CRITICAL_METHOD == 3                      
//     OS_CPU_SR  cpu_sr;
// #endif
// 	static u8 instruct = 0;
// //	static u8 segid = 0;
//     instruct = temp;
//     
// 	switch(instruct)
// 	{
//         case STOP_ALLFINITE://Í£Ö¹ËùÓĞ²»Ò»Ö±²¥µÄ

// 				wav_play_stop();//Í£Ö¹·ÅÒô
// 				Init_PlayStatus();

// 				FiniteListBuf.segaddr = 0;//Çå¿ÕÓĞÏŞ´Î²¥·ÅÁĞ±í
// 				FiniteListBuf.playtype = 0;
// 				FiniteListBuf.playtimes = 0;
// 				FiniteListBuf.playprior = 0;
// 				FiniteListBuf.playinterval = 0;

// 				FiniteListNodeNum = 0;

//         break;

//         case STOP_ALLINFINITE://Í£Ö¹ËùÓĞÒ»Ö±²¥µÄ

//                 wav_play_stop();//Í£Ö¹·ÅÒô
//                 Init_PlayStatus();
// 				OS_ENTER_CRITICAL();
// 				Del_AllNode();
// 				OS_EXIT_CRITICAL();							
//             
// 				Init_FreeList();
//             
//         break;
// 				
// 		default:
// 			break;
// 	}
// }
/********************************************************************************************
* º¯ÊıÃû³Æ£ºPlayCondition ()
* ¹¦ÄÜÃèÊö£º·ÅÒô×´Ì¬ÅĞ¶¨
* Èë¿Ú²ÎÊı£ºÎŞ
* ³ö¿Ú²ÎÊı£º·ÅÒôÄ£Ê½
* Ê¹ÓÃËµÃ÷£ºÎŞ
********************************************************************************************/
u8 PlayCondition(void)
{	
	if((VM8978Status.allcomplete==1)&&(FiniteListBuf.blockvalid==0))
	{
        VM8978Status.allcomplete = 0;
		 if(FiniteList.blockvalid !=1)
        {
            FiniteListNodeNum=0;
        }
	}
	
    if((FiniteListNodeNum > 0)&&(InFiniteListNodeNum == 0))//½öÓĞÏŞ´Î²¥·ÅÁĞ±í·Ç¿Õ
    {
        return FINITE_ONLY;
    }
    if((FiniteListNodeNum == 0)&&(InFiniteListNodeNum > 0))//½öÖØ¸´²¥·ÅÁĞ±í·Ç¿Õ
    {
        return INFINITE_ONLY;
    }
    if((FiniteListNodeNum > 0)&&(InFiniteListNodeNum > 0))//¼ÈÓĞÖØ¸´²¥±¨£¬ÓÖÓĞÓĞÏŞ´Î²¥±¨
    {
        return FINITE_INFINITE_BOTH;
    }
    

	return IDEL;
}
/********************************************************************************************
* º¯ÊıÃû³Æ£ºCopyInfor
* ¹¦ÄÜÃèÊö£º¿½±´ÉùÒôÆ¬¶ÎĞÅÏ¢µ½²¥·Å»ú
* Èë¿Ú²ÎÊı£ºÎŞ
* ³ö¿Ú²ÎÊı£ºÎŞ
* Ê¹ÓÃËµÃ÷£ºÎŞ
********************************************************************************************/
void CopyInfor( _PlayICBBuf *point)
{
    VM8978Status.mode = (*point).playtype;
    VM8978Status.playtimes = (*point).playtimes;
    VM8978Status.timeinterval = (*point).playinterval;
    VM8978Status.segaddr = (*point).segaddr;
    VM8978Status.PlayStatus = 1;
	(*point).blockvalid=0;
}
/********************************************************************************************
* º¯ÊıÃû³Æ£ºCopyFinInfor
* ¹¦ÄÜÃèÊö£º¿½±´ÓĞÏŞ´ÎÉùÒôÆ¬¶ÎĞÅÏ¢µ½ÓĞÏŞ´Î½á¹¹Ìå»º´æÖĞ
* Èë¿Ú²ÎÊı£ºÎŞ
* ³ö¿Ú²ÎÊı£ºÎŞ
* Ê¹ÓÃËµÃ÷£ºÎŞ
********************************************************************************************/
void CopyFinInfor( _PlayICBBuf *point)
{
	FiniteListBuf.segaddr = (*point).segaddr;
    FiniteListBuf.playtype = (*point).playtype;
    FiniteListBuf.playtimes = (*point).playtimes;
    FiniteListBuf.playprior = (*point).playprior;
    FiniteListBuf.playinterval = (*point).playinterval;
	FiniteListBuf.blockvalid = (*point).blockvalid;
}
/*******************************************************************************
* º¯ÊıÃû³Æ£ºVM8978StartPlay
* ¹¦ÄÜÃèÊö: VM8978¿ªÊ¼²¥·Å
* Èë¿Ú²ÎÊı£ºÎŞ
* ³ö¿Ú²ÎÊı£ºÎŞ
* Ê¹ÓÃËµÃ÷£º
********************************************************************************/
void VM8978StartPlay(void)
{
    VM8978Status.complete = 0;
}


/********************************************************************************************
* º¯ÊıÃû³Æ£ºTaskPlayLogic ()
* ¹¦ÄÜÃèÊö£ºÊä³öÉÁµÆ
* Èë¿Ú²ÎÊı£ºÎŞ
* ³ö¿Ú²ÎÊı£ºÎŞ
* Ê¹ÓÃËµÃ÷£ºÎŞ
********************************************************************************************/
void TaskPlayLogic(void *pdata)
{
	#if OS_CRITICAL_METHOD == 3                    
    OS_CPU_SR  cpu_sr = 0;
    #endif

	u8 err;
    u16* msg;
    u8 PlayJudgement = 0;
    u8 tmpjudgement;
    u8 p[2] = {0};

    Init_PlayStatus();
    ADC1Init_Base();//³õÊ¼»¯ADC
    DMAADCInit_Base();
    ADC_SoftwareStartConvCmd(ADC1, ENABLE);
    OSTimeDly(10);
	while(1)
    {
        msg = (u16 *)OSQAccept(MsgQueue,&err);
		if(msg != (void *)0)//²¥·ÅÁĞ±íÎ¬»¤
		{
			DealPlayInstrction(msg);
		}
        ADCfliter(ADCConvertedValue,ADCBUFFER);
        if(VolumeCtr.VolumeNow != VolumeCtr.VolumePre)//ÒôÁ¿¿ØÖÆ
        {
			VolumeCtr.VolumePre = VolumeCtr.VolumeNow;
			wm8978_ChangeVolume(VolumeCtr.VolumeNow,VolumeCtr.VolumeNow);
        }
        tmpjudgement = PlayCondition();
        switch(PlayJudgement)
        {
            case IDEL_PLAY: 
				if((tmpjudgement == FINITE_ONLY)||(tmpjudgement == FINITE_INFINITE_BOTH))//Á½ÖÖÓïÒô¶¼´ı²¥·Å
				{
					CopyFinInfor(&FiniteList);//¿½±´²¥·ÅĞÅÏ¢µ½²¥·Å»º´æÖĞ²
					CopyInfor(&FiniteListBuf);//¿½±´²¥·ÅĞÅÏ¢µ½²¥·Åic£
					PlayJudgement = FINITE_PLAY;
					break;
				}
				else if(tmpjudgement == INFINITE_ONLY)//Ö»ÓĞÖØ¸´²¥·ÅÓïÒô
				{
					InFiniteListCurPlay = InFiniteListHead;//²¥·ÅÖ¸Õë¸úËæÍ·Ö¸Õë
					CopyInfor(InFiniteListCurPlay);
					PlayJudgement = INFINITE_PLAY;
					break;
				}
				Init_PlayStatus();//Çå¿Õ²¥·Å»úĞÅÏ¢
				break;
            case FINITE_PLAY:
                if(tmpjudgement == INFINITE_ONLY)//Ö»Ê£ÖØ¸´²¥·ÅÀàĞÍÓïÒô¡¤
                {
                    CopyInfor(InFiniteListCurPlay);
					PlayJudgement = INFINITE_PLAY;
                    break;
                }
                else if(tmpjudgement == IDEL)//²¥·ÅÍê³É
                {
                    PlayJudgement = IDEL_PLAY;
                    break;
                }
                if(VM8978Status.complete == 1)//²¥·ÅÍê±Ï´¦Àí
                {   
 					if(FiniteList.blockvalid==1)
					{	
						CopyFinInfor(&FiniteList);//¿½±´²¥·ÅĞÅÏ¢µ½²¥·Å»º´æÖĞ?
						CopyInfor(&FiniteListBuf);
						FiniteList.blockvalid=0;
					}
                    if(FiniteListBuf.playtimes > 0)//Æ¬¶Î²¥·Å´ÎÊıÎ´Çå³ı
                    {
                        VM8978Status.complete = 0;
                        FiniteListBuf.playtimes--;
                        CopyInfor(&FiniteListBuf);//ÔÙ´ÎÔØÈë´ı²¥·ÅÓïÒô
                        VM8978StartPlay();                     
                    }
                    else
                    {
                        CAN_TxFrame(FRAMEID_LOWTOUP_STOPACK,p,1);
						VM8978Status.allcomplete=1;//Õû¸öÓïÒô¶ÎÍêÈ«²¥·ÅÍê±Ï
                        break;
                    }
					if((FiniteList.segaddr == VM8978Status.segaddr)&&(FiniteNodeSame==1))//20160926ĞŞ¸Ä³ÉÏàÍ¬µÄÓïÒô£¬µ¥´Ê²¥·ÅÍê³Éºó²ÅÄÜ²¥·ÅĞÂµÄÓïÒô¡£
					{
						wav_play_stop();//Í£Ö¹·ÅÒô
						Init_PlayStatus();//Çå¿Õ²¥·Å»úĞÅÏ¢
						OSTimeDly(20);	
						CopyFinInfor(&FiniteList);//¿½±´²¥·ÅĞÅÏ¢µ½²¥·Å»º´æÖĞ´
						CopyInfor(&FiniteListBuf);//¿½±´²¥·ÅĞÅÏ¢µ½²¥·Åic£
						FiniteNodeSame=2; //²¥·ÅĞÂµÄ²¥·ÅÖ¸Áî
					}
                }
//                if(FiniteList.segaddr != VM8978Status.segaddr)//½ÓÊÕµ½ĞÂµÄ²¥·ÅÖ¸Áî
//                {
//                    wav_play_stop();//Í£Ö¹·ÅÒô
//                    Init_PlayStatus();//Çå¿Õ²¥·Å»úĞÅÏ¢
//                    OSTimeDly(20);
//					CopyFinInfor(&FiniteList);//¿½±´²¥·ÅĞÅÏ¢µ½²¥·Å»º´æÖĞ
//                    CopyInfor(&FiniteListBuf);//¿½±´²¥·ÅĞÅÏ¢µ½²¥·ÅicÅ
// 					FiniteList.blockvalid=0;
//                    break;
//                }
            break;
            case INFINITE_PLAY:
                if((tmpjudgement == FINITE_ONLY)||(tmpjudgement == FINITE_INFINITE_BOTH))//Á½ÖÖÓïÒô¶¼ÓĞ£¬ÓÅÏÈ²¥·ÅÓĞÏŞ´ÎÓïÒô
                {
                    wav_play_stop();//Í£Ö¹µ±Ç°²¥·ÅµÄ
                    Init_PlayStatus();//Çå¿Õ²¥·Å»úĞÅÏ¢
                    OSTimeDly(20);
					CopyFinInfor(&FiniteList);
                    CopyInfor(&FiniteListBuf);//¿½±´²¥·ÅĞÅÏ¢µ½²¥·Åic£¬²¢¿ªÊ¼²¥·Å
                    PlayJudgement = FINITE_PLAY;                    
                    break;
                }
                else if(tmpjudgement == IDEL)
                {
                    wav_play_stop();//Í£Ö¹µ±Ç°²¥·ÅµÄ
                    Init_PlayStatus();//Çå¿Õ²¥·Å»úĞÅÏ¢
                    PlayJudgement = IDEL_PLAY;
                    break;
                }
                if(VM8978Status.complete == 1)//Ñ­»·È¡ÏÂÒ»¶ÎÓïÒô
                {
                    if(SoftTimer.PlayIntervalTimer == 0)
                    {
						CopyInfor(InFiniteListCurPlay);
                        VM8978StartPlay(); 
                        OS_ENTER_CRITICAL();
                        if(InFiniteListCurPlay->next != InFiniteListTail)//Ã»ÓĞµ½×îºóÒ»¸ö³ÉÔ±£¬ÔòÒÆÏòÏÂÒ»³ÉÔ±
                        {
                            InFiniteListCurPlay = InFiniteListCurPlay->next;
							VM8978StartPlay();
                        }   
                        else//µ±Ç°ÊÇ×îºóÒ»¸ö³ÉÔ±£¬ÔòÒÆÏò¶ÓÍ·
                        {
                            SoftTimer.PlayIntervalTimer=PLAYALLDELAY;
							InFiniteListCurPlay = InFiniteListHead;
                        }
                        OS_EXIT_CRITICAL(); 

                    }
                }
            break;
				
			default:
				break;
        }
       OSTimeDly(10);	
    }
}
